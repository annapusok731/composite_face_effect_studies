<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Comparison Study</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        body.fullscreen {
            background-color: #ffffff;
        }
        
        #experiment-container {
            background: white;
            border-radius: 10px;
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #experiment-container.fullscreen {
            max-width: 100%;
            height: 100vh;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
        }
        
        .instruction-screen, .trial-screen, .complete-screen, .questionnaire-screen {
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        
        h3 {
            color: #444;
            margin: 20px 0 10px 0;
        }
        
        p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .images-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
            position: relative;
        }
        
        .image-option {
            width: 550px;
            height: 550px;
            object-fit: cover;
            border: 3px solid #ddd;
            border-radius: 8px;
        }
        
        body.fullscreen .image-option {
            width: 600px;
            height: 600px;
        }
        
        .choice-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .choice-btn {
            background-color: #2196F3;
            padding: 20px 40px;
            font-size: 18px;
            min-width: 150px;
        }
        
        .choice-btn:hover {
            background-color: #0b7dda;
        }
        
        .progress {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .hidden {
            display: none;
        }
        
        #consent-form {
            text-align: left;
            margin: 20px 0;
        }
        
        #consent-form label {
            display: block;
            margin: 10px 0;
        }
        
        #consent-form input[type="checkbox"] {
            margin-right: 10px;
        }
        
        .questionnaire-form {
            text-align: left;
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .question-item {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .question-item:last-child {
            border-bottom: none;
        }
        
        .question-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .radio-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-left: 10px;
        }
        
        .radio-options label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .radio-options input[type="radio"] {
            margin-right: 10px;
            cursor: pointer;
        }
        
        .error-message {
            color: #d32f2f;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .feedback-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .feedback-screen.correct {
            background-color: #4CAF50;
        }
        
        .feedback-screen.incorrect {
            background-color: #f44336;
        }
        
        .feedback-screen h2 {
            color: white;
            font-size: 72px;
            margin: 0;
        }
    </style>
</head>
<body>
    <div id="experiment-container">
        <div id="consent-screen" class="instruction-screen">
            <h1>Welcome to Our Study</h1>
            <p>Thank you for participating in this research study. This task involves viewing images and answering questions.</p>
            
            <div id="consent-form">
                <h3>Please confirm:</h3>
                <label>
                    <input type="checkbox" id="consent-age" required>
                    I am 18 years of age or older
                </label>
                <label>
                    <input type="checkbox" id="consent-understand" required>
                    I understand the study procedures
                </label>
                <label>
                    <input type="checkbox" id="consent-voluntary" required>
                    I understand participation is voluntary
                </label>
            </div>
            
            <button id="consent-btn" onclick="startExperiment()">I Consent - Begin Study</button>
        </div>
        
        <div id="instructions-screen" class="instruction-screen hidden">
            <h1>Instructions</h1>
            <p>In this task, you will see two images side by side.</p>
            <p>Your job is to decide if the two images show the SAME person or DIFFERENT people.</p>
            <p>Click the appropriate button below the images to make your choice.</p>
            <p>There will be practice trials first, followed by the main experiment.</p>
            <button onclick="startTrials()">Start Practice Trials</button>
        </div>
        
        <div id="trial-screen" class="trial-screen hidden">
            <div class="progress" id="progress-text"></div>
            
            <div class="images-container">
                <img id="image-left" class="image-option" src="" alt="Option 1">
                <img id="image-right" class="image-option" src="" alt="Option 2">
            </div>
            
            <div class="choice-buttons">
                <button class="choice-btn" id="same-btn" onclick="recordResponse('same')">SAME</button>
                <button class="choice-btn" id="different-btn" onclick="recordResponse('different')">DIFFERENT</button>
            </div>
        </div>
        
        <div id="questionnaire-screen" class="questionnaire-screen hidden">
            <h1>Social Behavior Questionnaire</h1>
            <p>Please answer these questions about your social behavior</p>
            
            <div class="questionnaire-form" id="srs-form"></div>
            
            <div id="questionnaire-error" class="error-message hidden">
                Please answer all questions before continuing.
            </div>
            
            <button onclick="submitQuestionnaire()">Submit Questionnaire</button>
        </div>
        
        <div id="complete-screen" class="complete-screen hidden">
            <h1>Study Complete!</h1>
            <p>Thank you for participating in this study.</p>
            <p id="completion-code-text"></p>
            <button onclick="downloadData()">Download Data</button>
        </div>
        
        <div id="feedback-screen" class="feedback-screen hidden">
            <h2 id="feedback-text"></h2>
        </div>
    </div>

    <script>
        let currentTrial = 0;
        let isPractice = true;
        let practiceTrials = [];
        let trials = [];
        let responses = [];
        let questionnaireResponses = {};
        let startTime;
        let participantId;
        
        const completionCode = 'EXP' + Math.random().toString(36).substr(2, 9).toUpperCase();
        participantId = 'P' + Date.now() + '_' + Math.random().toString(36).substr(2, 6).toUpperCase();
        
        function initializePracticeTrials() {
            practiceTrials = [
                {
                    trialNumber: 1,
                    images: ['test_stimuli/william_arnold.jpg', 'test_stimuli/arnold_william.jpg'],
                    correctAnswer: 'different',
                    condition: 'practice'
                },
                {
                    trialNumber: 2,
                    images: ['test_stimuli/bridget_bridget.jpg', 'test_stimuli/bridget_alexis.jpg'],
                    correctAnswer: 'same',
                    condition: 'practice'
                }
            ];
        }
        
        const srsQuestions = [
            { id: "Q1", text: "I am much more uncomfortable in social situations than when I am by myself." },
            { id: "Q2", text: "My facial expressions send the wrong message to others about how I actually feel." },
            { id: "Q3", text: "I feel self-confident when interacting with others." },
            { id: "Q4", text: "When under stress, he or she shows rigid or inflexible patterns of behaviors that seem odd." },
            { id: "Q5", text: "I do not recognize when others are trying to take advantage of me." },
            { id: "Q6", text: "I would rather be alone than with others." },
            { id: "Q7", text: "I am usually aware of how others are feeling." },
            { id: "Q8", text: "I behave in ways that seem strange or bizarre to others." },
            { id: "Q9", text: "I am overly dependent on others for help with meeting my everyday needs." },
            { id: "Q10", text: "I take things too literally, and because of that, I misinterpret the intended meaning of parts of a conversation." },
            { id: "Q11", text: "I have good self-confidence." },
            { id: "Q12", text: "I am able to communicate my feelings to others." },
            { id: "Q13", text: "I am awkward in turn-taking interactions with others (for example, I have a hard time keeping up with the give-and-take of a conversation)." },
            { id: "Q14", text: "I am not well coordinated." },
            { id: "Q15", text: "When people change their tone or facial expression, I usually pick up on that and understand what it means." },
            { id: "Q16", text: "I avoid eye contact or am told that I have unusual eye contact." },
            { id: "Q17", text: "I recognize when something is unfair." },
            { id: "Q18", text: "I have difficulty making friends, even when trying my best." },
            { id: "Q19", text: "I get frustrated trying to get ideas across in conversations." },
            { id: "Q20", text: "I have sensory interests that others find unusual (for example, smelling or looking at things in a special way)." },
            { id: "Q21", text: "I am able to imitate others' actions and expressions when it is socially appropriate to do so." },
            { id: "Q22", text: "I interact appropriately with other adults." },
            { id: "Q23", text: "I do not join group activities or social events unless prompted or strongly urged to do so." },
            { id: "Q24", text: "I have more difficulty than others with changes in my routine." },
            { id: "Q25", text: "I do not mind going out of step with or 'not on the same wavelength' as others." },
            { id: "Q26", text: "I offer comfort to others when they are sad." },
            { id: "Q27", text: "I avoid starting social interactions with other adults." },
            { id: "Q28", text: "I think or talk about the same thing over and over." },
            { id: "Q29", text: "I am regarded by others as odd or weird." },
            { id: "Q30", text: "I become upset in situations with lots of things going on." },
            { id: "Q31", text: "I can't get my mind off something once I start thinking about it." },
            { id: "Q32", text: "I have good personal hygiene." },
            { id: "Q33", text: "My behavior is socially awkward, even when I am trying to be polite." },
            { id: "Q34", text: "I avoid people who want to be emotionally close to me." },
            { id: "Q35", text: "I have trouble keeping up with the flow of a normal conversation." },
            { id: "Q36", text: "I have difficulty relating to family members." },
            { id: "Q37", text: "I have difficulty relating to adults outside of my family." },
            { id: "Q38", text: "I respond appropriately to mood changes in others (for example, when a friend's mood changes from happy to sad)." },
            { id: "Q39", text: "People think I am interested in too few topics, or that I get too carried away with those topics." },
            { id: "Q40", text: "I am imaginative." },
            { id: "Q41", text: "I sometimes seem to wander aimlessly from one activity to another." },
            { id: "Q42", text: "I am overly sensitive to certain sounds, textures, or smells." },
            { id: "Q43", text: "I enjoy small talk (casual conversation with others)." },
            { id: "Q44", text: "I have more trouble than most people with understanding chains of causation (in other words, how events are related to one another)." },
            { id: "Q45", text: "When others around me are paying attention to something, I get interested in what they are attending to." },
            { id: "Q46", text: "Others feel that I have overly serious facial expressions." },
            { id: "Q47", text: "I laugh at inappropriate times." },
            { id: "Q48", text: "I have a good sense of humor and can understand jokes." },
            { id: "Q49", text: "I do extremely well at certain kinds of intellectual tasks, but do not do as well at most other tasks." },
            { id: "Q50", text: "I have repetitive behaviors that others consider odd." },
            { id: "Q51", text: "I have difficulty answering questions directly and end up talking around the subject." },
            { id: "Q52", text: "I get overly loud without realizing it." },
            { id: "Q53", text: "I tend to talk in a monotone voice (in other words, less inflection of voice than most people demonstrate)." },
            { id: "Q54", text: "I tend to think about people in the same way that I do objects." },
            { id: "Q55", text: "I get too close to others or invade their personal space without realizing it." },
            { id: "Q56", text: "I sometimes make the mistake of walking between two people who are trying to talk to one another." },
            { id: "Q57", text: "I tend to stare at myself." },
            { id: "Q58", text: "I concentrate too much on parts of things rather than seeing the whole picture." },
            { id: "Q59", text: "I am more suspicious than most people." },
            { id: "Q60", text: "Other people think I am emotionally distant and do not show my feelings." },
            { id: "Q61", text: "I tend to be inflexible." },
            { id: "Q62", text: "When I tell someone my reason for doing something, it strikes the person as unusual or illogical." },
            { id: "Q63", text: "My way of greeting another person is unusual." },
            { id: "Q64", text: "I am much more tense in social settings than when I am by myself." },
            { id: "Q65", text: "I find myself staring or gazing off into space." }
        ];
        
        const answerOptions = ["Not True", "Sometimes True", "Often True", "Almost Always True"];
        
        function shuffle(array) {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
        
        function get_stim_names(names, conditions) {
            let left_right_stim = [];
            for (let i = 0; i < names.length; i++) {
                let cond = conditions[i];
                let name = names[i].split("_");
                let image1 = name[0];
                let image2 = name[1];
                
                if (cond === 'diff_align') {
                    left_right_stim.push({
                        images: ['misaligned/' + image1 + '_' + image2 + '.jpg', 
                                'misaligned/' + image2 + '_' + image1 + '.jpg'],
                        condition: 'diff_align',
                        correctAnswer: 'different'
                    });
                } else if (cond === 'diff_misalign') {
                    left_right_stim.push({
                        images: ['aligned2/' + image1 + '_' + image2 + '.jpg', 
                                'aligned2/' + image2 + '_' + image1 + '.jpg'],
                        condition: 'diff_misalign',
                        correctAnswer: 'different'
                    });
                } else if (cond === 'same') {
                    let x = (Math.floor(Math.random() * 2) === 0);
                    if (x) {
                        left_right_stim.push({
                            images: ['aligned2/' + image1 + '_' + image2 + '.jpg', 
                                    'aligned2/' + image1 + '_' + image1 + '.jpg'],
                            condition: 'same_aligned',
                            correctAnswer: 'same'
                        });
                        left_right_stim.push({
                            images: ['misaligned/' + image2 + '_' + image2 + '.jpg', 
                                    'misaligned/' + image2 + '_' + image1 + '.jpg'],
                            condition: 'same_misaligned',
                            correctAnswer: 'same'
                        });
                    } else {
                        left_right_stim.push({
                            images: ['aligned2/' + image2 + '_' + image2 + '.jpg', 
                                    'aligned2/' + image2 + '_' + image1 + '.jpg'],
                            condition: 'same_aligned',
                            correctAnswer: 'same'
                        });
                        left_right_stim.push({
                            images: ['misaligned/' + image1 + '_' + image2 + '.jpg', 
                                    'misaligned/' + image1 + '_' + image1 + '.jpg'],
                            condition: 'same_misaligned',
                            correctAnswer: 'same'
                        });
                    }
                }
            }
            return left_right_stim;
        }
        
        function initializeExperiment() {
            let conditions = ["same", "same", "same", "same", "same", "same", 
                            "diff_align", "diff_align", "diff_align", 
                            "diff_misalign", "diff_misalign", "diff_misalign"];
            let females = ["emma_lili", "beth_zoe", "grace_hanna", "vanessa_sara", 
                          "liv_rose", "tammy_daisy", "tess_mary", "mimi_kelly", 
                          "dolly_laura", "amber_jess", "isabel_nora", "lisa_paige"];
            let males = ["carter_liam", "mike_jason", "rick_alex", "james_ted", 
                        "bob_andy", "steven_conrad", "owen_tom", "will_dan", 
                        "cody_zack", "leo_oliver", "harry_john", "david_luca"];
            
            conditions = shuffle(conditions);
            
            const all_faces = females.concat(males);
            const all_conditions = conditions.concat(shuffle([...conditions]));
            
            trials = get_stim_names(all_faces, all_conditions);
            trials = shuffle(trials);
            
            trials.forEach((trial, i) => {
                trial.trialNumber = i + 1;
                if (Math.random() < 0.5) {
                    trial.images = [trial.images[1], trial.images[0]];
                }
            });
        }
        
        function generateQuestionnaire() {
            const form = document.getElementById('srs-form');
            form.innerHTML = '';
            
            srsQuestions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                
                const questionTitle = document.createElement('div');
                questionTitle.className = 'question-title';
                questionTitle.textContent = `${index + 1}. ${question.text}`;
                questionDiv.appendChild(questionTitle);
                
                const radioOptions = document.createElement('div');
                radioOptions.className = 'radio-options';
                
                answerOptions.forEach(option => {
                    const label = document.createElement('label');
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = question.id;
                    radio.value = option;
                    
                    label.appendChild(radio);
                    label.appendChild(document.createTextNode(option));
                    radioOptions.appendChild(label);
                });
                
                questionDiv.appendChild(radioOptions);
                form.appendChild(questionDiv);
            });
        }
        
        function startExperiment() {
            const ageChecked = document.getElementById('consent-age').checked;
            const understandChecked = document.getElementById('consent-understand').checked;
            const voluntaryChecked = document.getElementById('consent-voluntary').checked;
            
            if (!ageChecked || !understandChecked || !voluntaryChecked) {
                alert('Please check all consent boxes to continue.');
                return;
            }
            
            document.getElementById('consent-screen').classList.add('hidden');
            document.getElementById('instructions-screen').classList.remove('hidden');
            
            initializePracticeTrials();
            initializeExperiment();
        }
        
        function startTrials() {
            document.getElementById('instructions-screen').classList.add('hidden');
            document.getElementById('trial-screen').classList.remove('hidden');
            
            enterFullscreen();
            
            currentTrial = 0;
            isPractice = true;
            showTrial();
        }
        
        function enterFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
            
            document.body.classList.add('fullscreen');
            document.getElementById('experiment-container').classList.add('fullscreen');
        }
        
        function showTrial() {
            const currentTrialSet = isPractice ? practiceTrials : trials;
            
            if (currentTrial >= currentTrialSet.length) {
                if (isPractice) {
                    isPractice = false;
                    currentTrial = 0;
                    alert('Practice complete! Now starting the main experiment.');
                    showTrial();
                } else {
                    showQuestionnaire();
                }
                return;
            }
            
            const trial = currentTrialSet[currentTrial];
            startTime = Date.now();
            
            if (isPractice) {
                document.getElementById('progress-text').textContent = 
                    `Practice Trial ${trial.trialNumber} of ${practiceTrials.length}`;
            } else {
                document.getElementById('progress-text').textContent = 
                    `Trial ${trial.trialNumber} of ${trials.length}`;
            }
            
            const baseUrl = isPractice ? 
                'https://raw.githubusercontent.com/annapusok731/lookit-stimuli-template/master/' :
                'https://raw.githubusercontent.com/annapusok731/composite_face_effect_studies/main/CFE_Adult/';
            document.getElementById('image-left').src = baseUrl + trial.images[0];
            document.getElementById('image-right').src = baseUrl + trial.images[1];
            
            document.getElementById('same-btn').disabled = false;
            document.getElementById('different-btn').disabled = false;
        }
        
        function recordResponse(response) {
            const reactionTime = Date.now() - startTime;
            const currentTrialSet = isPractice ? practiceTrials : trials;
            const trial = currentTrialSet[currentTrial];
            
            document.getElementById('same-btn').disabled = true;
            document.getElementById('different-btn').disabled = true;
            
            const isCorrect = response === trial.correctAnswer;
            
            if (isPractice) {
                showFeedback(isCorrect);
                
                if (!isCorrect) {
                    setTimeout(() => {
                        hideFeedback();
                        document.getElementById('same-btn').disabled = false;
                        document.getElementById('different-btn').disabled = false;
                        startTime = Date.now();
                    }, 1500);
                    return;
                } else {
                    setTimeout(() => {
                        hideFeedback();
                        currentTrial++;
                        setTimeout(showTrial, 500);
                    }, 1500);
                    return;
                }
            }
            
            if (!isPractice) {
                responses.push({
                    participantId: participantId,
                    trialNumber: trial.trialNumber,
                    condition: trial.condition,
                    imageLeft: trial.images[0],
                    imageRight: trial.images[1],
                    correctAnswer: trial.correctAnswer,
                    participantResponse: response,
                    accuracy: isCorrect ? 1 : 0,
                    reactionTime: reactionTime
                });
            }
            
            currentTrial++;
            setTimeout(showTrial, 500);
        }
        
        function showFeedback(isCorrect) {
            const feedbackScreen = document.getElementById('feedback-screen');
            const feedbackText = document.getElementById('feedback-text');
            
            feedbackScreen.classList.remove('hidden', 'correct', 'incorrect');
            
            if (isCorrect) {
                feedbackScreen.classList.add('correct');
                feedbackText.textContent = 'CORRECT!';
            } else {
                feedbackScreen.classList.add('incorrect');
                feedbackText.textContent = 'INCORRECT - TRY AGAIN';
            }
        }
        
        function hideFeedback() {
            document.getElementById('feedback-screen').classList.add('hidden');
        }
        
        function showQuestionnaire() {
            document.getElementById('trial-screen').classList.add('hidden');
            document.getElementById('questionnaire-screen').classList.remove('hidden');
            
            generateQuestionnaire();
        }
        
        function submitQuestionnaire() {
            questionnaireResponses = {};
            let allAnswered = true;
            
            srsQuestions.forEach(question => {
                const selected = document.querySelector(`input[name="${question.id}"]:checked`);
                if (selected) {
                    questionnaireResponses[question.id] = selected.value;
                } else {
                    allAnswered = false;
                }
            });
            
            if (!allAnswered) {
                document.getElementById('questionnaire-error').classList.remove('hidden');
                return;
            }
            
            document.getElementById('questionnaire-error').classList.add('hidden');
            endExperiment();
        }
        
        function endExperiment() {
            document.getElementById('questionnaire-screen').classList.add('hidden');
            document.getElementById('complete-screen').classList.remove('hidden');
            
            document.getElementById('completion-code-text').innerHTML = 
                `<strong>Your completion code is: ${completionCode}</strong><br>` +
                `<strong>Participant ID: ${participantId}</strong>`;
            
            console.log('Experiment Data:', {
                participantId: participantId,
                completionCode: completionCode,
                responses: responses,
                questionnaireResponses: questionnaireResponses
            });
        }
        
        function downloadData() {
            let csvContent = 'participantId,trialNumber,condition,imageLeft,imageRight,correctAnswer,participantResponse,accuracy,reactionTime\n';
            
            responses.forEach(r => {
                csvContent += `${r.participantId},${r.trialNumber},${r.condition},${r.imageLeft},${r.imageRight},${r.correctAnswer},${r.participantResponse},${r.accuracy},${r.reactionTime}\n`;
            });
            
            csvContent += '\n\nQuestionnaire Responses:\n';
            csvContent += 'participantId,questionId,response\n';
            for (let [key, value] of Object.entries(questionnaireResponses)) {
                csvContent += `${participantId},${key},${value}\n`;
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `participant_${participantId}_data.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>